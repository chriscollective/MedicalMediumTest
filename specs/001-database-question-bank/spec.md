# Feature Specification: 資料庫題庫系統與分析功能

**Feature Branch**: `001-database-question-bank`
**Created**: 2025-10-30
**Status**: Draft
**Input**: 依現有專案的內容去延伸與改寫，每次測驗為20題，前10題固定為單選題，接下來11~15為多選題，最後五題為填空題。題庫連結到資料庫。後台管理員可以對題庫進行管理CRUD。每位使用者的作答紀錄會被記起來，並且進行分析，可以得到每個題目的正確率是多少、可以統計使用者得分的分布圖與數量。

## Clarifications

### Session 2025-10-30

- Q: 測驗進度（未完成的作答）應該在什麼時機保存？保存到哪裡？ → A: 不保存進度，重新整理後重新開始
- Q: 當管理員刪除題目時，已完成的測驗記錄中應該如何保留該題目資訊？ → A: 只儲存題目ID，刪除後顯示「題目已刪除」
- Q: 使用者識別ID的生命週期和生成方式是什麼？ → A: localStorage + UUID，關閉瀏覽器後ID不變
- Q: 當題庫超過20題時，是否需要避免使用者連續多次測驗中重複抽到相同題目？ → A: 完全隨機，不記錄歷史
- Q: 統計資料（正確率、得分分布）應該在什麼時候計算？ → A: 即時查詢計算，不儲存結果

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 從資料庫動態載入測驗題目 (Priority: P1) 🎯 MVP

使用者選擇書籍和難度後，系統從資料庫中隨機抽取20題（固定順序：前10題單選、第11-15題多選、第16-20題填空），呈現給使用者作答。

**Why this priority**: 這是核心功能的基礎。沒有資料庫題庫，其他所有功能都無法運作。必須先將硬編碼的題目遷移到資料庫。

**Independent Test**: 選擇任意書籍和難度組合，驗證系統能載入20題且題型順序正確（1-10單選、11-15多選、16-20填空）。

**Acceptance Scenarios**:

1. **Given** 使用者在首頁選擇「神奇西芹汁」且難度為「初階」，**When** 點擊「開始測驗」，**Then** 系統從資料庫載入20題並進入測驗頁面
2. **Given** 題庫中該書籍+難度組合的題目不足20題，**When** 使用者嘗試開始測驗，**Then** 系統顯示友善的錯誤訊息「題庫題目不足，請聯繫管理員」
3. **Given** 使用者正在作答第5題，**When** 重新整理頁面，**Then** 系統回到首頁，測驗進度不保留（需重新開始）
4. **Given** 資料庫連線失敗，**When** 使用者嘗試載入測驗，**Then** 系統顯示友善錯誤訊息並建議稍後再試

---

### User Story 2 - 記錄使用者作答歷史 (Priority: P1) 🎯 MVP

每次使用者完成測驗時，系統儲存完整的作答記錄，包含每一題的答案、正確與否、得分、測驗時間等資訊。

**Why this priority**: 作答記錄是分析功能的數據來源。沒有記錄就無法進行統計分析。此功能與 P1 Story 1 同等重要。

**Independent Test**: 完成一次測驗，檢查資料庫中是否正確儲存該次測驗的所有作答記錄（包含使用者識別、每題答案、正確率、得分、時間戳記）。

**Acceptance Scenarios**:

1. **Given** 使用者完成一次測驗並獲得15/20分，**When** 查看資料庫，**Then** 該次測驗記錄包含所有20題的作答明細、得分、作答時間
2. **Given** 使用者在測驗中途離開未完成，**When** 查看資料庫，**Then** 系統不會儲存未完成的測驗記錄
3. **Given** 同一使用者完成多次測驗，**When** 查看該使用者的歷史記錄，**Then** 所有測驗記錄按時間順序排列且互不覆蓋
4. **Given** 使用者識別資訊（session/cookie），**When** 作答記錄儲存時，**Then** 系統能夠關聯該記錄到特定使用者以便後續分析

---

### User Story 3 - 管理員題庫 CRUD 功能 (Priority: P2)

管理員登入後台後，可以新增、編輯、刪除、查看題庫中的題目。支援批次操作以提高效率。

**Why this priority**: 題庫管理是維護系統的必要功能，但系統上線初期可以手動透過資料庫操作。因此優先級次於核心測驗功能。

**Independent Test**: 管理員登入後台，執行新增一題、編輯一題、刪除一題的操作，驗證資料庫變更正確且前台測驗立即反映更新。

**Acceptance Scenarios**:

1. **Given** 管理員在後台新增一題單選題（包含題目、選項、正確答案、來源、解釋），**When** 儲存後，**Then** 該題目出現在題庫列表且可被測驗系統抽取
2. **Given** 管理員編輯現有題目的選項內容，**When** 儲存變更，**Then** 前台測驗立即使用新版本題目
3. **Given** 管理員選擇刪除某一題目，**When** 確認刪除，**Then** 該題目從題庫中移除且不再出現在測驗中（歷史記錄只保留題目ID，查看時顯示「題目已刪除」）
4. **Given** 管理員使用篩選功能（依書籍、難度、題型），**When** 查看題庫列表，**Then** 只顯示符合條件的題目
5. **Given** 管理員批次上傳10題（JSON格式），**When** 上傳成功，**Then** 所有題目正確新增到資料庫

---

### User Story 4 - 題目正確率統計 (Priority: P3)

管理員可以查看每一題的統計資料，包含：被作答次數、答對次數、正確率百分比。

**Why this priority**: 這是分析功能的第一部分，幫助管理員了解題目難度。但對核心測驗功能不是必需的。

**Independent Test**: 讓3位使用者完成測驗（包含同一題），驗證該題的統計資料正確顯示作答次數和正確率。

**Acceptance Scenarios**:

1. **Given** 題目A被作答100次，其中75次答對，**When** 管理員查看該題統計，**Then** 顯示「作答次數：100，正確率：75%」
2. **Given** 新題目尚未被任何人作答，**When** 管理員查看統計，**Then** 顯示「作答次數：0，正確率：N/A」
3. **Given** 管理員查看題庫列表，**When** 按正確率排序，**Then** 題目依正確率由低到高（或高到低）排列，方便找出過難或過簡單的題目
4. **Given** 管理員點擊某題的統計資料，**When** 展開詳細資訊，**Then** 顯示各選項的選擇分布（例如：選項A被選30次、選項B被選50次等）

---

### User Story 5 - 使用者得分分布統計 (Priority: P3)

管理員可以查看所有使用者的得分分布，包含：分數區間統計、總測驗次數、平均分數、分布圖表。

**Why this priority**: 這是整體數據分析功能，幫助管理員了解使用者表現。對測驗核心功能非必需，可最後實作。

**Independent Test**: 讓10位使用者完成測驗（得分範圍0-20），驗證統計頁面正確顯示得分分布和圖表。

**Acceptance Scenarios**:

1. **Given** 100次測驗記錄，得分範圍為5-20分，**When** 管理員查看得分分布，**Then** 顯示分數區間統計（例如：0-5分：0次、6-10分：15次、11-15分：50次、16-20分：35次）
2. **Given** 得分分布資料，**When** 管理員查看統計頁面，**Then** 以長條圖或直方圖呈現分數分布，視覺化呈現使用者表現
3. **Given** 所有測驗記錄，**When** 管理員查看總覽，**Then** 顯示總測驗次數、平均分數、中位數、最高分、最低分
4. **Given** 管理員選擇特定時間範圍（例如：最近7天），**When** 查看統計，**Then** 只顯示該時間範圍內的得分分布

---

### Edge Cases

- **資料庫題目不足20題**：使用者選擇的書籍+難度組合，若單選題不足10題、多選題不足5題、或填空題不足5題，系統無法生成測驗。需顯示清楚錯誤訊息。
- **重複抽題**：若題庫恰好只有20題，需確保不重複抽取同一題。若題庫超過20題，完全隨機抽取（不考慮使用者歷史，可能重複）。
- **測驗中途重新整理**：使用者重新整理頁面或關閉瀏覽器，進度不保留，需重新開始測驗。
- **並發作答**：多位使用者同時作答時，系統需正確記錄各自的答案，不互相干擾。
- **測驗中途資料庫故障**：使用者作答到一半時資料庫連線中斷，需優雅處理並顯示錯誤訊息。
- **管理員刪除正在使用的題目**：若某題目正在被使用者作答時被管理員刪除，該次測驗應使用當時載入的題目快照，不影響作答體驗。
- **已刪除題目的歷史記錄顯示**：查看錯題回顧時，若題目已被刪除，顯示「題目已刪除」而非完整題目內容。
- **極端統計數據**：正確率為0%或100%的題目，需特別標示以供管理員檢視。
- **大量歷史記錄**：隨著時間累積，作答記錄可能達到數萬筆，統計即時查詢需保持合理效能（數秒內完成）。

## Requirements *(mandatory)*

### Functional Requirements

#### 題庫管理

- **FR-001**: 系統 MUST 提供資料庫儲存題目，包含欄位：題目ID、題型（single/multiple/fill）、題目內容、選項、正確答案、書籍來源、章節頁數、解釋說明、難度
- **FR-002**: 系統 MUST 支援三種題型：單選題（single）、多選題（multiple）、填空題（fill）
- **FR-003**: 管理員 MUST 能夠新增題目，包含所有必填欄位的驗證（例如：單選題至少2個選項、多選題至少2個正確答案）
- **FR-004**: 管理員 MUST 能夠編輯現有題目的任何欄位
- **FR-005**: 管理員 MUST 能夠刪除題目，且系統提示確認防止誤刪
- **FR-006**: 管理員 MUST 能夠查看所有題目列表，支援分頁顯示（每頁10-20題）
- **FR-007**: 管理員 MUST 能夠篩選題目，依據：書籍、難度、題型、關鍵字搜尋
- **FR-008**: 系統 MUST 支援批次匯入題目（JSON 格式），並驗證資料格式正確性

#### 測驗生成

- **FR-009**: 系統 MUST 根據使用者選擇的書籍和難度，從資料庫中隨機抽取20題
- **FR-010**: 抽取的題目 MUST 遵循固定順序：第1-10題為單選題、第11-15題為多選題、第16-20題為填空題
- **FR-011**: 若題庫中該書籍+難度組合的題目數量不足（單選<10、多選<5、填空<5），系統 MUST 顯示錯誤訊息阻止測驗開始
- **FR-012**: 每次測驗 MUST 從符合條件的題目中完全隨機抽取20題（若題庫恰好20題則全部使用，若超過20題則隨機抽取但可能重複）
- **FR-013**: 系統 MUST 在使用者作答期間保持題目內容不變（即使管理員更新題目，當次測驗仍使用原版本）
- **FR-014**: 系統 MUST NOT 保存未完成的測驗進度（使用者重新整理頁面後需重新開始）

#### 作答記錄

- **FR-015**: 系統 MUST 在使用者完成測驗時，儲存完整作答記錄到資料庫
- **FR-016**: 作答記錄 MUST 包含：使用者識別（UUID儲存於localStorage）、測驗時間戳記、書籍、難度、每一題的題目ID（僅ID不含題目內容）、使用者答案、正確答案、是否答對、總得分
- **FR-017**: 系統 MUST 在使用者首次作答時生成唯一UUID並儲存於localStorage，後續測驗沿用同一ID（除非清除瀏覽器資料）
- **FR-018**: 使用者完成測驗前關閉頁面或離開，系統 MUST NOT 儲存未完成的測驗記錄
- **FR-019**: 作答記錄 MUST 永久保存（除非管理員明確刪除），用於後續統計分析
- **FR-020**: 系統 MUST 在查看錯題回顧時，若題目已被刪除，顯示「題目已刪除」訊息而非完整題目內容

#### 統計分析

- **FR-021**: 系統 MUST 在管理員查看統計時即時計算每一題的統計資料：被作答總次數、答對次數、正確率百分比（不預先儲存）
- **FR-022**: 管理員 MUST 能夠查看題庫中任一題目的即時統計資料
- **FR-023**: 管理員 MUST 能夠查看所有使用者的得分分布即時統計
- **FR-024**: 得分分布 MUST 包含：總測驗次數、平均分數、分數區間統計（0-5分、6-10分、11-15分、16-20分）
- **FR-025**: 系統 MUST 以圖表（長條圖或直方圖）視覺化呈現得分分布
- **FR-026**: 統計即時查詢 MUST 在合理時間內完成（一般情況下3秒內），即使歷史記錄達數千筆

#### 資料驗證

- **FR-027**: 新增或編輯單選題時，系統 MUST 驗證至少有2個選項且正確答案為選項之一
- **FR-028**: 新增或編輯多選題時，系統 MUST 驗證至少有2個選項且正確答案為選項的子集（至少2個正確答案）
- **FR-029**: 新增或編輯填空題時，系統 MUST 驗證填空選項（fillOptions）至少有2個選項且正確答案為其中之一
- **FR-030**: 系統 MUST 驗證所有必填欄位不得為空（題目內容、選項、正確答案、書籍來源）

### Key Entities

- **Question（題目）**: 代表題庫中的一道題目。屬性：題目ID、題型、題目文字、選項陣列、填空選項陣列、正確答案、書籍來源、章節頁數、解釋說明、難度、創建時間、更新時間。關聯：屬於某一書籍、對應多筆作答記錄。

- **Quiz（測驗）**: 代表一次完整的測驗實例。屬性：測驗ID、使用者識別、測驗時間、書籍、難度、題目列表（20題）、總得分。關聯：包含20筆作答記錄。

- **Answer（作答記錄）**: 代表使用者對某一題的作答。屬性：作答ID、測驗ID、題目ID、使用者答案、正確答案、是否答對、作答時間。關聯：屬於某一次測驗、對應某一道題目。

- **User（使用者識別）**: 代表作答的使用者（簡易識別）。屬性：使用者ID（session ID）、首次作答時間、作答次數。關聯：擁有多次測驗記錄。

- **QuestionStatistics（題目統計）**: 代表某一題的統計資料。屬性：題目ID、被作答次數、答對次數、正確率、各選項選擇次數分布。關聯：對應某一道題目。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者選擇書籍和難度後，系統能在2秒內載入20題並顯示第一題
- **SC-002**: 系統能夠儲存100%的完整測驗作答記錄（無資料遺失）
- **SC-003**: 管理員能在30秒內完成新增一題的操作（包含填寫所有欄位和儲存）
- **SC-004**: 題目統計資料（正確率）的計算誤差為0（100%準確）
- **SC-005**: 得分分布統計查詢在一般情況下（1000筆記錄內）能在3秒內完成
- **SC-006**: 系統能夠處理至少1000題的題庫規模，測驗抽題速度不受影響
- **SC-007**: 管理員查看題庫列表時，分頁載入速度在1秒內完成（每頁20題）
- **SC-008**: 使用者完成測驗後，作答記錄立即可用於統計分析（無延遲）
- **SC-009**: 系統在題庫題目不足時，100%顯示清楚錯誤訊息（不會載入空白或錯誤的測驗）
- **SC-010**: 多位使用者同時作答時（最多10人並發），每人的作答記錄互不干擾且正確儲存

## Assumptions

1. **資料庫選擇**: 使用輕量級嵌入式資料庫（如 SQLite）或簡易雲端資料庫服務，符合專案「簡單優先」原則
2. **使用者識別**: 使用 localStorage 儲存的 UUID 識別使用者，不需要完整的帳號註冊/登入系統
3. **使用者 ID 持久性**: 使用者 ID 在清除瀏覽器資料前永久保留，可長期追蹤同一裝置的作答記錄
4. **測驗進度**: 不保存未完成的測驗進度，重新整理頁面後需重新開始
5. **題目刪除處理**: 作答記錄只儲存題目ID，刪除後顯示「題目已刪除」而非完整題目快照
6. **抽題策略**: 完全隨機抽題，不記錄使用者歷史以避免重複（保持實作簡單）
7. **統計計算**: 統計資料即時計算不預先儲存，適合初期資料量（<10,000筆記錄）
8. **管理員登入**: 沿用現有的簡易管理員登入機制（AdminLogin），不需要完整的權限管理系統
9. **資料保留**: 作答記錄永久保存，不設定自動清理或歸檔機制（除非未來手動實作）
10. **題目版本控制**: 題目更新時不保留歷史版本（簡化實作），僅在測驗進行中鎖定題目快照
11. **並發處理**: 使用者並發量較低（<50人同時作答），不需要複雜的並發鎖機制
12. **批次匯入格式**: 批次匯入使用 JSON 格式（與現有題目結構一致）

## Out of Scope

以下功能明確**不包含**在本次實作範圍內：

- ❌ 完整的使用者帳號系統（註冊、登入、個人資料管理）
- ❌ 使用者個人歷史記錄查詢（使用者端只能看到當次測驗結果）
- ❌ 題目標籤系統或分類管理（僅依書籍+難度分類）
- ❌ 題目難度自動評估（基於正確率調整難度標籤）
- ❌ 排行榜或使用者間比較功能
- ❌ 測驗時間限制或計時功能
- ❌ 題目圖片或多媒體內容支援
- ❌ 匯出統計報表（Excel、PDF）
- ❌ 進階篩選（例如：依正確率範圍、作答次數範圍）
- ❌ 題目版本歷史追蹤
- ❌ 多語言支援
- ❌ 題目註解或討論功能

## Dependencies

- 現有專案的測驗頁面（QuizPage.tsx）和題目組件（QuestionCard.tsx）
- 現有專案的管理員登入機制（AdminLogin、AdminDashboard）
- 現有專案的結果頁面（ResultPage.tsx）顯示錯題回顧
- 瀏覽器支援 localStorage 或 sessionStorage（用於簡易使用者識別）
