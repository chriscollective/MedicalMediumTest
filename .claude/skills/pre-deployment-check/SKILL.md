---
name: pre-deployment-check
description: éƒ¨ç½²å‰çš„å®Œæ•´æª¢æŸ¥æ¸…å–®ï¼Œç¢ºä¿å‰å¾Œç«¯å»ºæ§‹æˆåŠŸã€æ¸¬è©¦é€šéã€ç’°å¢ƒè®Šæ•¸æ­£ç¢ºã€è³‡æ–™åº«é€£ç·šæ­£å¸¸ã€‚é—œéµå­—ï¼šéƒ¨ç½²ã€ä¸Šç·šã€deployã€buildã€productionã€ç™¼å¸ƒ
---

# éƒ¨ç½²å‰æª¢æŸ¥ Skill

æ­¤ Skill æä¾›**éƒ¨ç½²å‰çš„å®Œæ•´æª¢æŸ¥æ¸…å–®**ï¼Œç¢ºä¿æ‡‰ç”¨ç¨‹å¼å¯ä»¥å®‰å…¨ä¸Šç·šåˆ°ç”Ÿç”¢ç’°å¢ƒã€‚

## ğŸ¯ ä½¿ç”¨æ™‚æ©Ÿ

ç•¶ä½¿ç”¨è€…æåˆ°ï¼š
- ã€Œæº–å‚™éƒ¨ç½²ã€ã€ã€Œè¦ä¸Šç·šäº†ã€
- ã€Œdeployã€ã€ã€Œç™¼å¸ƒã€
- ã€Œæª¢æŸ¥ç”Ÿç”¢ç’°å¢ƒã€
- ã€Œæº–å‚™ productionã€

## ğŸ“‹ å®Œæ•´æª¢æŸ¥æ¸…å–®

### éšæ®µ 1ï¼šç’°å¢ƒæª¢æŸ¥ âœ…

#### 1.1 æª¢æŸ¥ç’°å¢ƒè®Šæ•¸

**å¿…è¦çš„ç’°å¢ƒè®Šæ•¸ï¼š**

```bash
# .env æª”æ¡ˆæª¢æŸ¥
MONGODB_URI=mongodb+srv://...           # MongoDB Atlas é€£ç·šå­—ä¸²
PORT=5000                               # å¾Œç«¯ç«¯å£
NODE_ENV=production                     # ç’°å¢ƒè¨­å®š
VITE_API_URL=https://your-domain/api    # å‰ç«¯ API ä½å€
```

**æª¢æŸ¥æŒ‡ä»¤ï¼š**
```bash
# ç¢ºèª .env æª”æ¡ˆå­˜åœ¨
ls -la .env

# ç¢ºèªé—œéµè®Šæ•¸ï¼ˆä¸é¡¯ç¤ºå€¼ï¼‰
node -e "require('dotenv').config(); console.log('MONGODB_URI:', process.env.MONGODB_URI ? 'âœ“' : 'âœ—'); console.log('NODE_ENV:', process.env.NODE_ENV)"
```

**âš ï¸ å®‰å…¨è­¦å‘Šï¼š**
- ä¸è¦å°‡ `.env` æäº¤åˆ° Git
- ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ä¸åŒçš„ç’°å¢ƒè®Šæ•¸
- MongoDB URI ä½¿ç”¨å¼·å¯†ç¢¼
- é™åˆ¶ MongoDB IP ç™½åå–®

---

#### 1.2 æª¢æŸ¥è³‡æ–™åº«é€£ç·š

```bash
# åŸ·è¡Œè³‡æ–™åº«é€£ç·šæ¸¬è©¦
npm run db:stats
```

**ç¢ºèªé …ç›®ï¼š**
- âœ“ å¯ä»¥é€£ç·šåˆ° MongoDB Atlas
- âœ“ è³‡æ–™åº«æœ‰æ­£ç¢ºçš„ Collectionsï¼ˆquestions, quizzes, leaderboards, admins, booksï¼‰
- âœ“ é¡Œç›®è³‡æ–™å·²åŒ¯å…¥
- âœ“ ç®¡ç†å“¡å¸³è™Ÿå·²å»ºç«‹

---

### éšæ®µ 2ï¼šç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ âœ…

#### 2.1 åŸ·è¡Œæ¸¬è©¦

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
npm test

# ç”¢ç”Ÿæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
npm run test:coverage
```

**æª¢æŸ¥æ¨™æº–ï¼š**
- âœ“ æ‰€æœ‰æ¸¬è©¦é€šé
- âœ“ æ¸¬è©¦è¦†è“‹ç‡ > 70%ï¼ˆå»ºè­°ï¼‰
- âœ“ ç„¡æ¸¬è©¦éŒ¯èª¤æˆ–è­¦å‘Š

---

#### 2.2 TypeScript å‹åˆ¥æª¢æŸ¥

```bash
# å‰ç«¯å‹åˆ¥æª¢æŸ¥
npx tsc --noEmit

# å¾Œç«¯å‹åˆ¥æª¢æŸ¥
npx tsc -p server/tsconfig.json --noEmit
```

**ç¢ºèªé …ç›®ï¼š**
- âœ“ ç„¡ TypeScript éŒ¯èª¤
- âœ“ ç„¡å‹åˆ¥ä¸åŒ¹é…å•é¡Œ

---

### éšæ®µ 3ï¼šå»ºæ§‹æª¢æŸ¥ âœ…

#### 3.1 å»ºæ§‹å‰ç«¯

```bash
npm run build
```

**æª¢æŸ¥é …ç›®ï¼š**
- âœ“ å»ºæ§‹æˆåŠŸï¼ˆç„¡éŒ¯èª¤ï¼‰
- âœ“ `dist/` ç›®éŒ„å·²ç”Ÿæˆ
- âœ“ æª¢æŸ¥å»ºæ§‹ç”¢ç‰©å¤§å°ï¼ˆè­¦å‘Šï¼šå–®å€‹æª”æ¡ˆ > 500KBï¼‰
- âœ“ ç„¡æœªä½¿ç”¨çš„ä¾è³´è­¦å‘Š

**å»ºæ§‹æˆåŠŸå¾Œæª¢æŸ¥æª”æ¡ˆï¼š**
```bash
# åˆ—å‡ºå»ºæ§‹ç”¢ç‰©
ls -lh dist/

# æª¢æŸ¥é—œéµæª”æ¡ˆå­˜åœ¨
ls dist/index.html dist/assets/
```

---

#### 3.2 å»ºæ§‹å¾Œç«¯

```bash
npm run server:build
```

**æª¢æŸ¥é …ç›®ï¼š**
- âœ“ å»ºæ§‹æˆåŠŸï¼ˆç„¡éŒ¯èª¤ï¼‰
- âœ“ `server/dist/` ç›®éŒ„å·²ç”Ÿæˆ
- âœ“ ä¸»è¦æª”æ¡ˆå­˜åœ¨ï¼ˆserver.js, models/, routes/ï¼‰

**å»ºæ§‹æˆåŠŸå¾Œæª¢æŸ¥æª”æ¡ˆï¼š**
```bash
# åˆ—å‡ºå¾Œç«¯å»ºæ§‹ç”¢ç‰©
ls -lh server/dist/

# æª¢æŸ¥ä¸»è¦æª”æ¡ˆ
ls server/dist/server.js
```

---

### éšæ®µ 4ï¼šåŠŸèƒ½æ¸¬è©¦ âœ…

#### 4.1 æœ¬åœ°ç”Ÿç”¢æ¨¡å¼æ¸¬è©¦

```bash
# å•Ÿå‹•ç”Ÿç”¢æ¨¡å¼å¾Œç«¯
NODE_ENV=production npm run server:start

# åœ¨å¦ä¸€å€‹çµ‚ç«¯æ©Ÿé è¦½å‰ç«¯ï¼ˆViteï¼‰
npm run preview
```

**æ‰‹å‹•æ¸¬è©¦é …ç›®ï¼š**
- [ ] é¦–é è¼‰å…¥æ­£å¸¸
- [ ] å¯ä»¥é¸æ“‡æ›¸ç±å’Œé›£åº¦
- [ ] æ¸¬é©—æµç¨‹å®Œæ•´ï¼ˆ20 é¡Œï¼‰
- [ ] å¯ä»¥æäº¤ç­”æ¡ˆ
- [ ] çµæœé é¢é¡¯ç¤ºæ­£ç¢º
- [ ] æ’è¡Œæ¦œåŠŸèƒ½æ­£å¸¸
- [ ] ç®¡ç†å“¡ç™»å…¥æˆåŠŸ
- [ ] ç®¡ç†å¾Œå°åŠŸèƒ½æ­£å¸¸ï¼ˆé¡Œç›®ç®¡ç†ã€çµ±è¨ˆåˆ†æï¼‰

---

### éšæ®µ 5ï¼šå®‰å…¨æ€§æª¢æŸ¥ âœ…

#### 5.1 æ•æ„Ÿè³‡è¨Šæª¢æŸ¥

```bash
# æª¢æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæª”æ¡ˆè¢«æäº¤
git ls-files | grep -E "\.env$|credentials|secrets|password"

# æª¢æŸ¥å»ºæ§‹ç”¢ç‰©ä¸­æ˜¯å¦æœ‰ç’°å¢ƒè®Šæ•¸æ´©æ¼
grep -r "mongodb+srv" dist/ || echo "âœ“ ç„¡è³‡æ–™åº«é€£ç·šå­—ä¸²æ´©æ¼"
```

#### 5.2 ä¾è³´å¥—ä»¶å®‰å…¨æª¢æŸ¥

```bash
# æª¢æŸ¥å·²çŸ¥æ¼æ´
npm audit

# è‡ªå‹•ä¿®å¾©ï¼ˆå¦‚æœæœ‰ï¼‰
npm audit fix
```

**è™•ç†å»ºè­°ï¼š**
- é«˜å±æ¼æ´ï¼ˆHigh/Criticalï¼‰ï¼š**å¿…é ˆä¿®å¾©**
- ä¸­å±æ¼æ´ï¼ˆModerateï¼‰ï¼šå»ºè­°ä¿®å¾©
- ä½å±æ¼æ´ï¼ˆLowï¼‰ï¼šè©•ä¼°å¾Œæ±ºå®š

---

#### 5.3 CORS è¨­å®šæª¢æŸ¥

**æª¢æŸ¥æª”æ¡ˆï¼š** `server/src/server.ts`

ç¢ºèª CORS è¨­å®šï¼š
```typescript
// âœ“ ç”Ÿç”¢ç’°å¢ƒåªå…è¨±è‡ªå·±çš„åŸŸå
const allowedOrigins = [
  'https://your-domain.com',
  'https://www.your-domain.com'
];

// âœ— ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ origin: '*'
```

---

#### 5.4 MongoDB æ³¨å…¥é˜²è­·

**æª¢æŸ¥æª”æ¡ˆï¼š** `server/src/server.ts`

ç¢ºèªå·²å•Ÿç”¨ï¼š
```typescript
import mongoSanitize from 'express-mongo-sanitize';
app.use(mongoSanitize());
```

---

### éšæ®µ 6ï¼šæ•ˆèƒ½æª¢æŸ¥ âœ…

#### 6.1 å»ºæ§‹ç”¢ç‰©å¤§å°

```bash
# å‰ç«¯
du -sh dist/
ls -lh dist/assets/*.js | awk '{if ($5 > 500) print "âš ï¸ " $0; else print "âœ“ " $0}'

# å¾Œç«¯
du -sh server/dist/
```

**æ¨™æº–ï¼š**
- å‰ç«¯ç¸½å¤§å°ï¼š< 5MBï¼ˆå»ºè­°ï¼‰
- å–®å€‹ JS æª”æ¡ˆï¼š< 500KBï¼ˆå»ºè­°ï¼‰

---

#### 6.2 åœ–ç‰‡å„ªåŒ–

```bash
# æª¢æŸ¥å¤§åœ–ç‰‡
find public/images -type f -size +500k
```

**å»ºè­°ï¼š**
- åœ–ç‰‡ä½¿ç”¨ WebP æ ¼å¼
- å£“ç¸® PNG/JPGï¼ˆTinyPNGï¼‰
- è€ƒæ…®ä½¿ç”¨ CDN

---

### éšæ®µ 7ï¼šGit æª¢æŸ¥ âœ…

#### 7.1 ç¢ºèªåˆ†æ”¯

```bash
# ç•¶å‰åˆ†æ”¯
git branch --show-current

# ç¢ºèªåœ¨ main åˆ†æ”¯
# æˆ–åˆä½µåˆ° main
```

#### 7.2 æäº¤æ‰€æœ‰è®Šæ›´

```bash
# æª¢æŸ¥ç‹€æ…‹
git status

# å¦‚æœ‰æœªæäº¤çš„è®Šæ›´
git add .
git commit -m "æº–å‚™éƒ¨ç½²è‡³ç”Ÿç”¢ç’°å¢ƒ"
```

#### 7.3 æ‰“æ¨™ç±¤ï¼ˆç‰ˆæœ¬è™Ÿï¼‰

```bash
# å»ºç«‹ç‰ˆæœ¬æ¨™ç±¤
git tag -a v1.0.0 -m "Release version 1.0.0"

# æ¨é€æ¨™ç±¤
git push origin v1.0.0
```

---

### éšæ®µ 8ï¼šå‚™ä»½è³‡æ–™åº« âœ…

**âš ï¸ é‡è¦ï¼šéƒ¨ç½²å‰å¿…é ˆå‚™ä»½ï¼**

```bash
# å‚™ä»½è³‡æ–™åº«
npm run backup
```

**ç¢ºèªï¼š**
- âœ“ å‚™ä»½æª”æ¡ˆå·²ç”Ÿæˆ
- âœ“ è¨˜éŒ„å‚™ä»½æª”æ¡ˆä½ç½®
- âœ“ æ¸¬è©¦é‚„åŸï¼ˆåœ¨æ¸¬è©¦ç’°å¢ƒï¼‰

---

## ğŸš€ éƒ¨ç½²æµç¨‹ï¼ˆåƒè€ƒï¼‰

### ä½¿ç”¨ Vercel éƒ¨ç½²ï¼ˆæ¨è–¦ï¼‰

#### å‰ç«¯éƒ¨ç½²

```bash
# å®‰è£ Vercel CLI
npm i -g vercel

# ç™»å…¥
vercel login

# éƒ¨ç½²
vercel --prod
```

#### å¾Œç«¯éƒ¨ç½²

**é¸é … 1ï¼šä½¿ç”¨ Vercel Serverless Functions**
- å°‡å¾Œç«¯æ”¹ç‚º Serverless æ¶æ§‹
- åƒè€ƒ Vercel Node.js æ–‡ä»¶

**é¸é … 2ï¼šä½¿ç”¨å…¶ä»–æœå‹™**
- Heroku
- Railway
- Render
- DigitalOcean

---

### ç’°å¢ƒè®Šæ•¸è¨­å®š

**Vercel ä»‹é¢è¨­å®šï¼š**
1. Project Settings â†’ Environment Variables
2. åŠ å…¥ï¼š
   - `MONGODB_URI`
   - `NODE_ENV=production`
   - å…¶ä»–å¿…è¦è®Šæ•¸

---

## âœ… æœ€çµ‚æª¢æŸ¥æ¸…å–®

éƒ¨ç½²å‰æœ€å¾Œç¢ºèªï¼š

### ç’°å¢ƒ
- [ ] `.env` æª”æ¡ˆè¨­å®šæ­£ç¢º
- [ ] `NODE_ENV=production`
- [ ] MongoDB é€£ç·šæ­£å¸¸

### ç¨‹å¼ç¢¼
- [ ] æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] TypeScript ç„¡éŒ¯èª¤
- [ ] ç„¡ ESLint è­¦å‘Š

### å»ºæ§‹
- [ ] å‰ç«¯å»ºæ§‹æˆåŠŸ
- [ ] å¾Œç«¯å»ºæ§‹æˆåŠŸ
- [ ] æœ¬åœ°ç”Ÿç”¢æ¨¡å¼æ¸¬è©¦é€šé

### å®‰å…¨æ€§
- [ ] ç„¡æ•æ„Ÿè³‡è¨Šæ´©æ¼
- [ ] ä¾è³´å¥—ä»¶ç„¡é«˜å±æ¼æ´
- [ ] CORS è¨­å®šæ­£ç¢º
- [ ] MongoDB æ³¨å…¥é˜²è­·å•Ÿç”¨

### æ•ˆèƒ½
- [ ] å»ºæ§‹ç”¢ç‰©å¤§å°åˆç†
- [ ] åœ–ç‰‡å·²å„ªåŒ–

### Git
- [ ] åœ¨æ­£ç¢ºçš„åˆ†æ”¯
- [ ] æ‰€æœ‰è®Šæ›´å·²æäº¤
- [ ] ç‰ˆæœ¬æ¨™ç±¤å·²å»ºç«‹

### è³‡æ–™åº«
- [ ] è³‡æ–™åº«å·²å‚™ä»½
- [ ] å‚™ä»½å¯é‚„åŸ

---

## ğŸ”§ å¸¸è¦‹å•é¡Œæ’è§£

### å•é¡Œ 1ï¼šå»ºæ§‹å¤±æ•—

**å¯èƒ½åŸå› ï¼š**
- TypeScript éŒ¯èª¤
- ä¾è³´å¥—ä»¶ç¼ºå¤±
- ç’°å¢ƒè®Šæ•¸æœªè¨­å®š

**è§£æ±ºæ–¹å¼ï¼š**
1. åŸ·è¡Œ `npx tsc --noEmit` æª¢æŸ¥å‹åˆ¥éŒ¯èª¤
2. åŸ·è¡Œ `npm install` é‡æ–°å®‰è£ä¾è³´
3. ç¢ºèª `.env` æª”æ¡ˆå­˜åœ¨

---

### å•é¡Œ 2ï¼šç”Ÿç”¢ç’°å¢ƒ API ç„¡æ³•é€£ç·š

**å¯èƒ½åŸå› ï¼š**
- `VITE_API_URL` è¨­å®šéŒ¯èª¤
- CORS è¨­å®šä¸æ­£ç¢º
- å¾Œç«¯æœªå•Ÿå‹•

**è§£æ±ºæ–¹å¼ï¼š**
1. æª¢æŸ¥ `.env` ä¸­çš„ `VITE_API_URL`
2. ç¢ºèªå¾Œç«¯ CORS å…è¨±å‰ç«¯åŸŸå
3. æª¢æŸ¥å¾Œç«¯æ˜¯å¦æ­£å¸¸é‹è¡Œ

---

### å•é¡Œ 3ï¼šMongoDB é€£ç·šå¤±æ•—

**å¯èƒ½åŸå› ï¼š**
- IP ç™½åå–®æœªè¨­å®š
- é€£ç·šå­—ä¸²éŒ¯èª¤
- ç¶²è·¯å•é¡Œ

**è§£æ±ºæ–¹å¼ï¼š**
1. MongoDB Atlas â†’ Network Access â†’ æ–°å¢éƒ¨ç½²ä¼ºæœå™¨ IP
2. ç¢ºèª `MONGODB_URI` æ ¼å¼æ­£ç¢º
3. æ¸¬è©¦é€£ç·šï¼š`npm run db:stats`

---

## ğŸ“š ç›¸é—œè³‡æº

- **Vercel æ–‡ä»¶ï¼š** https://vercel.com/docs
- **MongoDB Atlas æ–‡ä»¶ï¼š** https://www.mongodb.com/docs/atlas/
- **ç’°å¢ƒè®Šæ•¸æœ€ä½³å¯¦è¸ï¼š** https://12factor.net/config

---

**è¨˜ä½ï¼šæ¸¬è©¦ã€å‚™ä»½ã€å†éƒ¨ç½²ï¼**
